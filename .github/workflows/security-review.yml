name: Security Review

on:
  pull_request:
    paths:
      - "*/*auth"
      - "*/*login"
      - "*/*password"
      - "*/*token"
      - "*/*api"
      - "*/*database"
      - "*/*db"
      - "*/*sql"
      - "*/*payment"
      - "*/*security"
      - "*/*crypto"
      - "*/*session"

permissions:
  contents: read
  pull-requests: write

jobs:
  security-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

      - name: Get diff
        id: contents
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > diff.txt

      - name: Security Review with Claude
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('diff.txt', 'utf8');
            const files = fs.readFileSync('changed_files.txt', 'utf8');

            const prompt = 'SECURITY REVIEW - These files contain sensitive code paths:\n\n' + 
              files + '\n\nPerform a thorough security review of these changes:\n\n' + 
              diff + '\n\nCheck for:\n' +
              '- SQL injection vulnerabilities\n' +
              '- XSS vulnerabilities\n' +
              '- Authentication/authorization bypasses\n' +
              '- Insecure cryptographic practices\n' +
              '- Hardcoded secrets or credentials\n' +
              '- Insecure session management\n' +
              '- Input validation issues\n' +
              '- Path traversal vulnerabilities\n\n' +
              'Provide specific security recommendations.';

            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4096,
                messages: [{
                  role: 'user',
                  content: prompt
                }]
              })
            });

            const data = await response.json();
            const review = data.content[0].text;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## üîí Security Review\n\n‚ö†Ô∏è *This PR modifies security-sensitive files*\n\n' + review
            });
